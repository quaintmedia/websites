$(document).ready(function(){var t,a=0,B=300,w=false;$("#navBarbtn").click(function(){var I=false,H;if($("nav.NavLinks.mobile").length==0){$("header .NavLinks").clone().insertBefore(".layout").addClass("mobile").attr({id:"mobileMenu"})}else{if($("#mobileMenu:visible").length>0){$("#mobileMenu:visible").hide()}else{$("#mobileMenu").show()}}function J(){if(I==true){$("#mobileMenu:visible").hide()}}$("#mobileMenu:visible").mouseout(function(){I=true;H=setTimeout(function(){J()},200)});$("header").mouseout(function(){$("#mobileMenu:visible").mouseout()});$("#mobileMenu:visible").mouseover(function(){I=false;clearTimeout(H)});$("header").mouseover(function(){$("#mobileMenu:visible").mouseover()})});$("header .NavLinks a").hoverLock({duration:200,idPrefix:true,addSameClass:true,addClass:"hover",eToShow:$("#megaMenu"),eMouseOver:$("#megaMenu"),eMouseOut:$("#megaMenu"),urlToLoad:"http://"+document.domain+"/megaMenu.html",insertTo:$("#megaMenu"),loadCallback:megaMenuADs});var r=$(".topActivities .userLogin"),k=$("#usrNotifications"),n=mxpLoginData(),g={ntf:[],rec:[],wsl:[]},y={ntf:"MXP_Notification",rec:"MXP_Recommendation",wsl:"MXP_Wishlist"},d=$("#notcount"),f=[];if(n!=null){$(".topActivities .userLogin").hide();$(".usrLoginBlk").show();r=$("header .userPic");var G=n.image;if(!G){G=THEME_IMAGESITEPATH+"/noImage.gif"}$(".userPic img").attr("src",G);$(".notfication-top").prepend("<span>"+n.fname+"</span>");$(".logout-btn").html("Logout");$(".notfication-tab li.disabled").removeClass("disabled")}else{$(".topActivities .userLogin").show();$(".usrLoginBlk").hide()}$(".scroll-pane").jScrollPane({mouseWheelSpeed:50});k.focusDiv({excluded:[r]});var e=[];e.push($("#tab1 .scroll-pane").data("jsp"));e.push($("#tab2 .scroll-pane").data("jsp"));e.push($("#tab3 .scroll-pane").data("jsp"));function m(H){if(!H){for(var I=0;I<e.length;I++){e[I].reinitialise()}}else{e[H].reinitialise()}}function E(){g.ntf=readStorage(y.ntf,[]);g.rec=readStorage(y.rec,[]);g.wsl=readStorage(y.wsl,[]);setTimeout(function(){o()},2500);r.click(function(H){k.toggle();if(k.is(":visible")){$("#main-notify").click();m();A()}H.preventDefault()});$("a.showSingle").click(function(){var I=$(this),H=parseInt(I.attr("target"));if(I.parent(".disabled").length>0){return}k.find(".targetDiv").hide();k.find(".showSingle").removeClass("act");I.addClass("act");k.find("#tab"+H).show();m(H-1);$(".notfication-top .ttl").html(I.attr("title"))})}_notif_ui_render=false;function j(){if(_notif_ui_render){return}_notif_ui_render=true;var J=0;if(g.ntf.length>0){var L="";for(var I=0;I<g.ntf.length;I++){var K="notif_edge";if(g.ntf[I].type=="Wishlist"||g.ntf[I].type=="Recommended"){K="notif_cnt"}L=C(g.ntf[I],K)+L;if(g.ntf[I].flag==1){J++}}$("#tab1 ul").html(L);if(mxpLoginData()!=null){$("#tab1 .notfication-bottom").show()}$("#tab1 .scroll-pane").addClass("noBg")}else{$("#tab1 ul").html("");$("#tab1 .notfication-bottom").hide();$("#tab1 .scroll-pane").removeClass("noBg")}if(J>0){d.html(""+J).data("count",""+J).show();var H=document.title;document.title="("+J+") "+H.replace(/^\([0-9]+\) /i,"")}else{d.html("").data("count","0").hide()}if(g.rec.length>0){var L="";for(var I=0;I<g.rec.length;I++){L=C(g.rec[I],"cont")+L}$("#tab2 ul").html(L);$("#tab2 .notfication-bottom").show();$("#tab2 .scroll-pane").addClass("noBg")}else{$("#tab2 ul").html("");$("#tab2 .notfication-bottom").hide();$("#tab2.scroll-pane").removeClass("noBg")}if(g.wsl.length>0){var L="";for(var I=0;I<g.wsl.length;I++){L=C(g.wsl[I],"cont")+L}$("#tab3 ul").html(L);$("#tab3 .notfication-bottom").show();$("#tab3 .scroll-pane").addClass("noBg")}else{$("#tab3 ul").html("");$("#tab3 .notfication-bottom").hide();$("#tab3 .scroll-pane").removeClass("noBg")}m();_notif_ui_render=false}function o(){$.ajax({url:"http://"+document.domain+"/notifications.php?type=init",type:"get",dataType:"json",success:function(H){g.wsl=mergeStorageData(y.wsl,g.wsl,H.wishlist.data);g.ntf=mergeStorageData(y.ntf,g.ntf,g.wsl);f=H.comm_thumb},beforeSend:function(){},complete:function(){setTimeout(function(){u()},200)}})}function u(){setTimeout(function(){v()},200);$(document).on("mxpBeacon",function(L,K,J){if(K!="article"){return}var H=0;for(var I=0;I<g.rec.length;I++){if(g.rec[I].flag==1){H++}}if(H>=4){return}$.ajax({url:"http://"+document.domain+"/notifications.php?type=reco",type:"get",dataType:"json",success:function(S){var R=[];if(S.recommend&&S.recommend.length>0){S=S.recommend;for(var O=0;O<S.length;O++){var Q=true;for(var M=0;M<g.rec.length;M++){if(g.rec[M].id==S[O].id){Q=false}}if(Q){S[O].type="Recommended";S[O].flag=1;R.push(S[O])}if(R.length>=2){break}}}if(R.length>0){var N=R[0].thumb;var P='MensXP recommends <a href="'+R[0].link+'" target="_blank">'+R[0].title+"</a> for you. </a>";if(R.length>1){P='MensXP recommends <a href="'+R[1].link+'" target="_blank">'+R[1].title+'</a> and <a href="'+R[0].link+'" target="_blank">1 other</a> story for you. </a>';N=R[1].thumb}$("body").alertPopup({msg:P,thumb:N,thumbLnk:R[0].link,duration:6000})}g.rec=mergeStorageData(y.rec,g.rec,R);g.ntf=mergeStorageData(y.ntf,g.ntf,g.rec)},beforeSend:function(){},complete:function(){j()}})})}function b(N){var K=" ",T=" ",U="",O="",L=N.A_N+" ",S="",J="";var R=N.A_D_N,P="",I="",Q=null;if(N.A_K!="MXP"){O="_blank"}var H=N.iu;switch(N.A_N){case"Following":if(N.Mine=="true"){K=" are now "}else{K=" is now ";R="<a class='orange' href='javascript:void(0);' >"+N.A_D_N+"</a>"}S=N.O_D_N;if(S==undefined||S=="undefined"){S=""}if((N.type+"").toLowerCase()=="TOPIC".toLowerCase()){U=" community"}J="javascript:void(0);";break;case"Commented":if(N.A_K!=MYTIMES_MXP_KEY){return null}if(N.Mine!="true"){R="<a class='orange' href='javascript:void(0);' >"+N.A_D_N+"</a>"}S=N.tet;J=N.teu;T=" on ";break}if(S!=""){R=R+K+L.toLowerCase()+T+"<a class='orange' href='"+J+"' target='"+O+"'>"+S+"</a>"+U;if(!H||H==null||H=="null"){H=N.PIU}var M={id:N._id,uid:"nf_"+N._id,title:R,link:J,thumb:H,type:Q,posted:N.A_DT,target:O,flag:1};return M}return null}function v(){if(!mxpLoginData()){j()}else{var I=0,H=g.ntf.length-1;while(H>=0){if(g.ntf[H].uid.substring(0,3)=="nf_"){I=g.ntf[H].id;break}H--}var J=mytimes_activity_api+"/getFeed/User?callback=JSONPCallback&activityType=All&openNetworkId=sso&appKey=&size=50&lastSeenId="+I+"&after=true&contID=ln_allUpdates&_=1370422998514";jsonp.fetch(J,function(L){if(L){$.each(L,function(){var N=[],M=b(this);if(M){N.push(M)}g.ntf=mergeStorageData(y.ntf,g.ntf,N)});var K=setTimeout(function(){v()},20000)}else{var K=setTimeout(function(){v()},40000)}j()})}}function D(H){}function A(){var H=function(I){$.each(I,function(){this.flag=0})};H(g.ntf);H(g.wsl);H(g.rec);writeStorage(y.ntf,g.ntf);writeStorage(y.rec,g.rec);writeStorage(y.wsl,g.wsl);d.hide();document.title=document.title.replace(/^\([0-9]+\) /i,"")}function C(J,I){var H="<li>";if(J.flag){H='<li class="unread">'}if(I=="cont"){H+='<a href="'+J.link+'" title="" >';H+='<div class="left-thumb" style="background-image: url('+J.thumb+');"></div>';H+='<div class="right-desc">'+J.title+"</div>";H+='<div class="bottom-desc">';H+='<span class="rc">'+fancyDateFormat(J.posted)+"</span></div>";H+="</a>"}else{if(I=="follow"){H+='<a href="'+J.link+'" title="" >';H+='<div class="left-thumb" style="background-image: url('+J.thumb+');"></div>';H+="</a>";H+='<div class="right-desc">'+J.title+"</div>";H+='<a href="javascript:void(0);" class="follow-btn">Follow</a>';H+='<div class="bottom-desc">';H+='<span class="rc">'+fancyDateFormat(J.posted)+"</span></div>"}else{if(I=="notif_cnt"){H+='<a href="'+J.link+'" title="" >';H+='<div class="left-thumb" style="background-image: url('+J.thumb+');"></div>';H+='<div class="right-desc">'+J.title+"</div>";H+='<div class="bottom-desc">';if(J.type=="Wishlist"){H+='<span class="not-type">Saved</span>'}else{H+='<span class="not-type">'+J.type+"</span>"}H+='<span class="rc">'+fancyDateFormat(J.posted)+"</span></div>";H+="</a>"}else{if(I=="notif_edge"){H+='<a href="'+J.link+'" title="" >';H+='<div class="left-thumb" style="background-image: url('+J.thumb+');"></div>';H+="</a>";H+='<div class="right-desc">'+J.title+"</div>";H+='<div class="bottom-desc">';H+='<span class="rc">'+fancyDateFormat(J.posted)+"</span></div>"}}}}H+="</li>";return H}E();$.each($("img"),function(){var H=$(this);if(!H.hasClass("art-lazy")&&!H.hasClass("nolazy")){if(H.width()>200&&H.height()>90){if(H.offset().top>$(window).height()){H.attr({"data-original":H.attr("src")});H.attr({src:THEME_IMAGESITEPATH+"/transparent.gif"});H.addClass("greyBg lazy")}}}});setTimeout(function(){$("img.lazy").lazyload({effect:"fadeIn",failurelimit:1000})},2000);$("img.art-lazy").each(function(){var H=$(this);if(!H.hasClass("anim-gif")){if(H.width()>200&&H.height()>90){if(H.offset().top>$(window).height()&&H.data("original")){H.removeAttr("src")}}}H.lazyload({failurelimit:1000,threshold:50})});var z;$(".logout-btn").click(function(H){if(!mxpLoginData()){showLoginPopup()}else{signOut()}k.hide()});$(document).on("click",".SignUpBlock .SubscribeBtn",function(H){x($(".SignUpBlock input").val())});function x(H){if(isValidEmail(H)){$.ajax({url:"/api/news_subscribe.php",cache:false,data:{email:H,action:"subscribe"},type:"post",async:false,success:function(I){xpalert(I);return{status:1,response:I}},error:function(){return{status:0,response:"Failed to process request"}},beforeSend:function(){$(".SignUpBlock .ProfilePic").addClass("loading")},complete:function(){$(".SignUpBlock input").val("");$(".SignUpBlock .ProfilePic").removeClass("loading")}})}else{$(".SignUpBlock input").val("");$(".SignUpBlock input").attr("placeholder","ENTER A VALID EMAIL");return{status:0,response:"Invalid Email ID"}}}$(document).on("click","a.add-wishlist",function(I){var H=$(this).data("wsdata");p($(this),H.i,H.h,H.u,H.t)});$(document).on("click","#wsltOp",function(H){$("body").openPop({url:"http://"+document.domain+"/wishlist.php",width:"650",height:"500",})});$(document).on("click","#clr-wslt",function(H){F();$("#disabledBg").click();$(document).find(".Block figure a.star.act").each(function(){$(this).removeClass("act")})});function l(O,M,I,N){if(JSON.stringify){var H=_tkr_init(),K=parseCookie(H.save_ck,[]),J;for(J=0;J<K.length;J++){if(K[J]==O){return false}}K.push(O);if(K.length>H.save_count){K.shift()}Set_Cookie(H.save_ck,JSON.stringify(K),H.save_exp,"/");var L=[];L.push({id:O,uid:"wl_"+O,title:M,link:I,thumb:N,type:"Wishlist",flag:1});g.wsl=mergeStorageData(y.wsl,g.wsl,L);g.ntf=mergeStorageData(y.ntf,g.ntf,L);j();return true}return false}function c(){if(JSON.parse){var H=_tkr_init();return parseCookie(H.save_ck,[])}return[]}function F(){if(JSON.stringify){var H=_tkr_init();Set_Cookie(H.save_ck,JSON.stringify([]),H.save_exp,"/");writeStorage(y.wsl,[]);g.wsl=[];j()}}function p(K,J,L,I,M){if(l(J,L,I,M)){if(mxpLoginData()!=null){var H={title:L,activity:"Saved",entity_type:"article",url:I,imageUrl:M};trackActivity(H)}K.addClass("act");$("body").alertPopup({msg:"Article added to your wishlist. View <a id='wsltOp' href='javascript:void(0)'>wishlist</a>",thumb:M,thumbLnk:I,duration:5000})}else{$("body").alertPopup({msg:"<p style='margin: 8px;'>Article already present in your wishlist. View <a id='wsltOp' href='javascript:void(0)'>wishlist</a></p>",duration:5000})}}function i(){var J=c();for(var H=0;H<J.length;H++){var I=$(document).find("#card_"+J[H]+" a.star");if(I&&I.length>0){I.addClass("act")}}}i();var h=null,q=null,s=$("#searchContainer");s.find(".searchField").keyup(function(){if(q){clearTimeout(q);q=null}q=setTimeout(function(){if(h!==null){h.abort()}var H=$(".searchField").val();if(H.length>2){h=$.ajax({type:"GET",url:"/contentsearch.php",async:true,data:"q="+H,beforeSend:function(){var I='<div class="ttl"> Loading search results... </div>';$("#sr0000").html(I)},success:function(I){$("#sr0000").html(I)},complete:function(){}})}else{$("#sr0000").html("")}},1000)});$("#searchForm").submit(function(H){H.preventDefault()});$("a.search").click(function(){ga("send","event","Search","Local search","Popup open")});$(document).on("click","a.social-custom",function(N){var H=$(this),M=H.data("social"),I=null;if(M){switch(M.type){case"Facebook":I="http://www.facebook.com/sharer/sharer.php?p[url]="+M.url;break;case"Facebook UI":break;case"Tweet":I="https://twitter.com/intent/tweet?url="+M.url+"&via=MensXP&related=MensXP&text="+M.title;break;case"Linkedin":break;case"Reddit":I="http://www.reddit.com/submit?url="+M.url+"&title="+M.title;break;case"Google Plus":I="https://plus.google.com/share?url={"+M.url+"}";break;case"Pinterest":I="https://pinterest.com/pin/create/button/?url="+M.url+"&media="+M.thumb+"&description="+M.title;break;case"Comment":if($(".comment-pop").length>0){$(".comment-pop").remove()}else{var P='<div class="showCnt comment-pop"><a href="javascript:void(0);" class="close">X</a><span class="title">Share your Comment</span><span class="str_img"><a href="javascript:void(0);"><img src="'+M.thumb+'"></a></span><span><a href="javascript:void(0);">'+M.title+'</a></span><input name="comment" type="text" class="input" value="" placeholder="comment"><input type="button" class="cm_btn" value="Post to Comment" ></div>';H.after(P);var Q=H.siblings(".comment-pop");Q.show();Q.focusDiv({excluded:[H],hideCallback:function(){Q.remove();H.removeClass("act")}});Q.find(".cm_btn").click(function(){var R=Q.find(".input").val();try{$("#comment_text").val(R);Q.find(".cm_btn").val("Posting..");commentAPI(R);Q.find(".cm_btn").val("Post to Comment");Q.find(".input").val("")}catch(S){}});Q.find("a.close").click(function(){Q.remove();H.removeClass("act")})}H.toggleClass("act");break}if(I){var K=500;var J=640;var L=(screen.height/2)-(K/2);var O=(screen.width/2)-(J/2);window.open(I,M.title,"top="+L+",left="+O+",toolbar=0,status=0,width="+J+",height="+K)}ga("send","event","Social Share",M.type,{page:M.url})}})});_community_data=null;function updateBtnElem(c){var a=false,d=c.data("follow_data");for(var b in _community_data){var e=_community_data[b];if(d.name==e.tn){a=true;break}}if(a){c.addClass("selected").html("Following").show()}else{c.removeClass("selected").html("Follow").show()}}function updateCommunityBtn(b){var a=mxpLoginData();$(document).find(".mxp_follow_btn").each(function(){var c=$(this);if(a!=null){if(!_community_data||b==true){var d=mytimes_follow_api+"/topic/detail?size=50&lastSeenId=0&after=true&callback=JSONPCallback";jsonp.fetch(d,function(e){_community_data=e;updateBtnElem(c)})}else{updateBtnElem(c)}}else{c.html("Follow").show()}})}function updateCommunityCount(){$(document).find(".mxp_follow_btn").each(function(){var a=$(this),b=a.data("follow_data")})}$(function(){updateCommunityBtn();$(document).on({mouseenter:function(){$(this).html("Unfollow")},mouseleave:function(){$(this).html("Following")}},".mxp_follow_btn.selected");$(document).on("click",".mxp_follow_btn",function(){if(mxpLoginData()!=null){var a=$(this),b=a.data("follow_data");if(a.hasClass("selected")){var c=mytimes_follow_api+"topic/remove?callback=JSONPCallback&topicNames="+b.name;jsonp.fetch(c,function(d){a.removeClass("selected").html("Follow");setTimeout(function(){updateCommunityBtn(true)},10000)})}else{var c=mytimes_follow_api+"topic/add?topicNames="+b.name+"&callback=JSONPCallback";jsonp.fetch(c,function(e){a.addClass("selected").html("Following");var d={title:name,activity:"Like",entity_type:"topic",url:getBrowserUri()};trackActivity(d);setTimeout(function(){updateCommunityBtn(true)},10000)})}}else{showLoginPopup()}})});